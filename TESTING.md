# Руководство по тестированию

## Обзор

Проект использует многоуровневую стратегию тестирования:

1. **Быстрые тесты на SQLite** - для PR и быстрой обратной связи
2. **Полные тесты на PostgreSQL** - для main ветки и nightly builds
3. **Тесты производительности** - для выявления проблем с производительностью

## Структура тестов

### Unit тесты (`tests/Unit/`)
- Тестируют отдельные классы и методы
- Быстрые, изолированные
- Не требуют базы данных

### Feature тесты (`tests/Feature/`)
- Тестируют полные пользовательские сценарии
- Интеграционные тесты
- Требуют базы данных

### PostgreSQL совместимость (`tests/Feature/PostgreSQLCompatibilityTest.php`)
- Специальные тесты для PostgreSQL
- Проверяют совместимость типов данных
- Тестируют специфичные для PostgreSQL функции

### Тесты производительности (`tests/Feature/Performance/`)
- Тестируют производительность на больших объемах данных
- Проверяют использование индексов
- Тестируют память и время выполнения

## Локальное тестирование

### Быстрые тесты (для разработки)

```bash
# Все тесты на SQLite
make test

# Только быстрые тесты для PR
make test-quick

# Только unit тесты
php artisan test --testsuite=Unit
```

### Тестирование на PostgreSQL

#### Вариант 1: Локальный PostgreSQL

```bash
# Убедитесь, что PostgreSQL запущен
pg_isready

# Запуск тестов
make test-postgresql
```

#### Вариант 2: Docker (рекомендуется)

```bash
# Запуск всех версий PostgreSQL
make test-all-postgresql

# Или пошагово:
make docker-test-up    # Запуск контейнеров
make test-postgresql    # Тестирование
make docker-test-down  # Остановка контейнеров
```

### Тесты производительности

```bash
# Тесты производительности
make test-performance

# Тесты с покрытием кода
make test-coverage
```

## CI/CD конфигурация

### GitHub Actions

#### Для Pull Requests
- **Быстрые тесты**: Unit + Smoke Feature на SQLite
- **PHP версии**: 8.2, 8.3
- **Время выполнения**: ~2-3 минуты

#### Для main ветки
- **Полные тесты**: Все тесты на PostgreSQL
- **PostgreSQL версии**: 13, 14, 15
- **PHP версии**: 8.2, 8.3
- **Время выполнения**: ~10-15 минут

#### Nightly тесты
- **Полная матрица**: Все комбинации PHP/PostgreSQL
- **Покрытие кода**: Включено
- **Время выполнения**: ~30-45 минут

### Конфигурация

Файлы CI:
- `.github/workflows/ci.yml` - Основные тесты
- `.github/workflows/nightly.yml` - Nightly тесты

## Переменные окружения

### SQLite (по умолчанию)
```env
DB_CONNECTION=sqlite
DB_DATABASE=database/testing.sqlite
```

### PostgreSQL
```env
DB_CONNECTION=pgsql
DB_HOST=localhost
DB_PORT=5432
DB_DATABASE=testing
DB_USERNAME=postgres
DB_PASSWORD=postgres
```

## Скрипты

### `scripts/test-quick.sh`
Быстрые тесты для PR на SQLite

### `scripts/test-postgresql.sh`
Тесты на PostgreSQL (требует запущенный PostgreSQL)

### `scripts/test-all-postgresql.sh`
Тесты на всех версиях PostgreSQL через Docker

## Makefile команды

```bash
make help              # Показать справку
make test              # Все тесты на SQLite
make test-quick        # Быстрые тесты для PR
make test-postgresql   # Тесты на PostgreSQL
make test-all-postgresql # Тесты на всех версиях PostgreSQL
make test-performance  # Тесты производительности
make test-coverage     # Тесты с покрытием
make clean             # Очистка кэша
make setup             # Настройка проекта
```

## Docker окружение

### Запуск тестового окружения

```bash
# Запуск всех версий PostgreSQL
docker-compose -f docker-compose.test.yml up -d

# Проверка статуса
docker-compose -f docker-compose.test.yml ps

# Остановка
docker-compose -f docker-compose.test.yml down
```

### Порты PostgreSQL
- PostgreSQL 13: 5434
- PostgreSQL 14: 5435  
- PostgreSQL 15: 5433
- PostgreSQL 16: 5436

## Отладка тестов

### Проблемы с PostgreSQL

1. **Подключение не работает**:
   ```bash
   # Проверьте, что PostgreSQL запущен
   pg_isready
   
   # Проверьте права доступа
   psql -U postgres -c "SELECT 1;"
   ```

2. **Docker контейнеры не запускаются**:
   ```bash
   # Очистите Docker
   make docker-test-clean
   
   # Перезапустите
   make docker-test-up
   ```

### Проблемы с тестами

1. **Тесты падают на PostgreSQL**:
   - Проверьте совместимость типов данных
   - Убедитесь, что миграции выполнены
   - Проверьте настройки PostgreSQL

2. **Медленные тесты**:
   - Используйте `make test-quick` для быстрой проверки
   - Проверьте индексы в базе данных
   - Убедитесь, что тесты не создают лишних данных

## Лучшие практики

### Написание тестов

1. **Unit тесты**:
   - Тестируйте один метод/класс
   - Используйте моки для зависимостей
   - Быстрые и изолированные

2. **Feature тесты**:
   - Тестируйте полные пользовательские сценарии
   - Используйте реальную базу данных
   - Очищайте данные между тестами

3. **PostgreSQL тесты**:
   - Тестируйте специфичные для PostgreSQL функции
   - Проверяйте совместимость типов данных
   - Тестируйте производительность

### CI/CD

1. **PR тесты**:
   - Быстрые тесты на SQLite
   - Фокус на unit тестах
   - Время выполнения < 5 минут

2. **Main тесты**:
   - Полные тесты на PostgreSQL
   - Все feature тесты
   - Время выполнения < 20 минут

3. **Nightly тесты**:
   - Полная матрица тестов
   - Покрытие кода
   - Время выполнения < 60 минут

## Мониторинг

### Метрики производительности

- Время выполнения тестов
- Использование памяти
- Покрытие кода
- Количество тестов

### Алерты

- Тесты падают на PostgreSQL
- Медленные тесты (> 30 секунд)
- Низкое покрытие кода (< 80%)
- Проблемы с производительностью

## Заключение

Эта стратегия тестирования обеспечивает:

1. **Быструю обратную связь** для разработчиков
2. **Высокое качество** кода
3. **Совместимость** с продакшн базой данных
4. **Производительность** приложения

Используйте соответствующий уровень тестирования для ваших нужд и следуйте лучшим практикам для поддержания качества кода.



